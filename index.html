<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Majalah Digital Interaktif</title>
    <meta name="description" content="Baca berita dan informasi terkini yang disajikan secara dinamis.">
    <meta property="og:title" content="Majalah Digital Interaktif" />
    <meta property="og:description" content="Baca berita dan informasi terkini dari komunitas kami." />
    <meta property="og:image" content="https://placehold.co/1200x630/1b5e20/ffffff?text=Majalah+Digital" />
    <meta property="og:url" content="" />
    <meta property="og:type" content="article" />
    <meta property="twitter:card" content="summary_large_image" />
    <style>
        :root { --warna-utama: #1b5e20; --warna-aksen: #ffc107; }
        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body { font-family: 'Georgia', 'Times New Roman', Times, serif; margin: 0; padding: 0; background-color: #f8f9fa; color: #333; }
        .admin-controls { max-width: 800px; margin: 20px auto; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; padding: 10px; border-radius: 12px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .admin-btn { padding: 6px 14px; font-size: 0.8em; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #btn-new-article, #btn-archive, #btn-edit-pengaturan, #btn-share { color: white; }
        #btn-new-article { background-color: var(--warna-utama); }
        #btn-archive { background-color: #546e7a; }
        #btn-edit-pengaturan { background-color: #e65100; }
        #btn-share { background-color: #007bff; }
        .admin-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1001; backdrop-filter: blur(2px); }
        .modal-content { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); padding: 20px; border-radius: 12px; width: 90%; max-width: 450px; max-height: 90vh; overflow-y: auto; box-shadow: 0 5px 20px rgba(0,0,0,0.2); position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h2 { margin: 0; color: var(--warna-utama); font-size: 1.2em; }
        .modal-close-btn { font-size: 1.8em; font-weight: bold; cursor: pointer; color: #aaa; line-height: 1; }
        .modal-close-btn:hover { color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #2e7d32; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-group textarea { height: 100px; resize: vertical; }
        .btn-update { display: flex; justify-content: center; align-items: center; gap: 10px; width: 100%; padding: 10px; background-image: linear-gradient(to right, #28a745 0%, #218838 51%, #28a745 100%); background-size: 200% auto; color: white; border: none; border-radius: 5px; font-size: 1em; font-weight: bold; cursor: pointer; transition: 0.5s; }
        .btn-update:hover { background-position: right center; }
        .spinner { width: 18px; height: 18px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; display: none; }
        .btn-update.loading .spinner { display: block; }
        .btn-update.loading .btn-text { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .header-inner { max-width: 800px; margin: 0 auto; display: flex; align-items: center; padding: 10px 25px; border-bottom: 4px solid var(--warna-aksen); background-color: #ffffff; }
        header .logo img { height: 60px; width: auto; }
        .title-container { flex-grow: 1; text-align: center; min-width: 0; padding: 0 15px; }
        header h1 { font-size: clamp(1.5em, 4vw, 2.2em); color: var(--warna-utama); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .magazine-subtitle { font-size: 0.8em; font-style: italic; color: #555; margin: 4px 0 0 0; line-height: 1.3; }

        .container-majalah { max-width: 800px; margin: 0 auto; background-color: #ffffff; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        main { padding: 22px; }
        article .judul-artikel { font-size: clamp(1.8em, 5vw, 2.2em); margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #388e3c; }
        .artikel-container::after { content: ""; clear: both; display: table; }
        .foto-samping { float: left; width: 45%; max-width: 320px; margin-right: 15px; margin-bottom: 10px; }
        .foto-samping-inner { display: flex; flex-wrap: wrap; }
        .foto-samping-inner a { display: block; box-sizing: border-box; padding: 0; }
        .foto-samping-inner img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .foto-samping[data-count="1"] a { width: 100%; }
        .foto-samping[data-count="2"] a { width: 50%; }
        .foto-samping[data-count="3"] a, .foto-samping[data-count="4"] a { width: 50%; }
        .teks-artikel { text-align: justify; line-height: 1.6; font-size: 1em; position: relative; }
        .konten-terpotong { max-height: 250px; overflow: hidden; position: relative; padding-bottom: 30px; }
        .konten-terpotong::after { content: ''; position: absolute; bottom: 30px; left: 0; width: 100%; height: 50px; background: linear-gradient(to bottom, transparent, white); }
        .baca-selengkapnya-btn { display: none; margin: -20px auto 20px auto; padding: 8px 20px; border: 1px solid var(--warna-utama); background-color: white; color: var(--warna-utama); font-weight: bold; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; }
        .baca-selengkapnya-btn:hover { background-color: var(--warna-utama); color: white; }
        .teks-artikel table { width: 100%; border-collapse: collapse; margin: 1em 0; font-size: 0.9em; white-space: normal; }
        .teks-artikel th, .teks-artikel td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .teks-artikel th { background-color: #f2f2f2; }
        .teks-artikel tr:nth-child(even) { background-color: #f9f9f9; }
        .teks-artikel > p { margin: 0 0 1em 0; }
        
        .footer-inner { max-width: 800px; margin: 0 auto; }
        footer { background-color: var(--warna-utama); color: #ffffff; }
        .footer-content { display: flex; flex-direction: column; gap: 15px; padding-top: 15px; }
        .footer-content-inner { display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 15px; font-size: 0.9em; padding: 0 15px; }
        #footerMedsos a { display: inline-flex; align-items: center; gap: 8px; text-decoration: none; color: white; transition: opacity 0.3s; }
        #footerMedsos a:hover { opacity: 0.8; }
        .news-ticker-wrap { width: 100%; background-color: rgba(0,0,0,0.2); padding: 8px 0; overflow: hidden; white-space: nowrap; }
        .news-ticker { display: inline-block; animation: ticker-scroll 60s linear infinite; }
        .news-ticker-wrap:hover .news-ticker { animation-play-state: paused; }
        .news-ticker-item { display: inline-block; margin: 0 20px; color: #fff; text-decoration: none; font-style: italic; }
        .news-ticker-item:hover { text-decoration: underline; }
        @keyframes ticker-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .skeleton { animation: skeleton-pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes skeleton-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .skeleton-text { height: 1em; background-color: #e0e0e0; border-radius: 4px; }
        .skeleton-img { background-color: #e0e0e0; }
        .archive-list { list-style: none; padding: 0; }
        .archive-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #ddd; }
        .archive-item span { flex-grow: 1; margin-right: 10px; }
        .archive-item button { font-size: 0.8em; padding: 4px 8px; }
        
        @media (min-width: 651px) {
            body { padding: 0; }
        }

        @media (max-width: 650px) { 
            body { padding-top: 85px; padding-bottom: 140px; overflow-x: hidden; }
            header { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
            footer { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 999; }
            .header-inner { padding: 10px 15px; }
            header h1 { padding: 0 10px; font-size: clamp(1.8em, 7vw, 2.8em); }
            .magazine-subtitle { font-size: 0.7em; }
            article .judul-artikel { font-size: 1.4em; }
            .footer-content { gap: 10px; }
            .footer-content-inner { font-size: 0.75em; }
            .teks-artikel { font-size: 1.1em; }
            .foto-samping[data-count="1"] { float: left; width: 45%; margin-right: 15px; }
            .foto-samping[data-count="2"], .foto-samping[data-count="3"], .foto-samping[data-count="4"] { float: none; width: 100%; margin-right: 0; }
        }
    </style>
</head>
<body>

    <div id="admin-panel" class="admin-controls">
        <button id="btn-new-article" class="admin-btn">Tulis Berita Baru</button>
        <button id="btn-archive" class="admin-btn">Arsip Berita</button>
        <button id="btn-edit-pengaturan" class="admin-btn">Edit Pengaturan</button>
        <button id="btn-share" class="admin-btn">Bagikan</button>
    </div>

    <div id="adminModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <span id="modalClose" class="modal-close-btn">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>
    
    <div id="shareModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Bagikan Link</h2>
                <span id="shareModalClose" class="modal-close-btn">&times;</span>
            </div>
            <div class="form-group">
                <label for="share-link-public">Link untuk Pembaca:</label>
                <input type="text" id="share-link-public" readonly style="background-color: #eee;">
            </div>
            <button class="btn-update" onclick="copyShareLink('share-link-public')">Salin Link Pembaca</button>
            <hr style="margin: 20px 0;">
            <div class="form-group">
                <label for="share-link-contributor">Link untuk Penulis:</label>
                <input type="text" id="share-link-contributor" readonly style="background-color: #eee;">
            </div>
            <button class="btn-update" onclick="copyShareLink('share-link-contributor')">Salin Link Penulis</button>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <h2>Konfirmasi</h2>
            </div>
            <p id="confirm-message">Apakah Anda yakin?</p>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button id="confirm-btn-no" class="admin-btn" style="background: #6c757d;">Batal</button>
                <button id="confirm-btn-yes" class="admin-btn" style="background: #c82333;">Ya</button>
            </div>
        </div>
    </div>

    <header>
        <div class="header-inner">
            <div class="logo logo-kua"><a id="logoKuaLink" href="#" target="_blank"><img id="logoKuaImg" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Logo KUA"></a></div>
            <div class="title-container">
                <h1 id="namaMajalah"></h1>
                <p id="majalahSubtitle" class="magazine-subtitle"></p>
            </div>
            <div class="logo logo-masjid"><a id="logoMasjidLink" href="#" target="_blank"><img id="logoMasjidImg" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Logo Masjid"></a></div>
        </div>
    </header>

    <div id="majalah-wrapper" style="display:none; opacity:0;">
        <div class="container-majalah">
            <main>
                <article>
                    <h2 class="judul-artikel" id="artikelJudul"></h2>
                    <div class="artikel-container">
                        <div class="foto-samping"><div class="foto-samping-inner" id="foto-container"></div></div>
                        <div id="artikelTeksWrapper">
                            <div class="teks-artikel" id="artikelTeks"></div>
                        </div>
                    </div>
                </article>
            </main>
        </div>
    </div>
    
    <footer>
        <div class="footer-inner">
            <div class="footer-content">
                <div class="news-ticker-wrap">
                    <div class="news-ticker" id="news-ticker"></div>
                </div>
                <div class="footer-content-inner">
                    <div id="footerMedsos"></div>
                    <div id="footerKontak"></div>
                    <div id="footerAlamat"></div>
                </div>
            </div>
        </div>
    </footer>

    <div id="skeleton-loader"><div class="container-majalah"><header class="skeleton"><div style="height: 120px;"></div></header><main><div class="judul-artikel skeleton skeleton-text" style="height: 2.2em; width: 80%; margin-bottom: 20px;"></div><div class="artikel-container"><div class="foto-samping skeleton skeleton-img" style="height: 250px;"></div><div class="teks-artikel"><p class="skeleton skeleton-text"></p><p class="skeleton skeleton-text"></p><p class="skeleton skeleton-text"></p></div></div></main><footer class="skeleton"><div style="height: 100px;"></div></footer></div></div>
    <div id="error-container" style="display: none; max-width: 800px; margin: 20px auto; padding: 20px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; color: #721c24;"><h2>Masalah Kritis</h2><p id="error-message"></p><p>Periksa kembali panduan penyiapan Google Sheets Anda.</p></div>

    <script>
        const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzswbfPgXcpUzsP3oHTt16-kPUBPcFceebghaBdXeKgOo9aq7932mZi20e8Orxcor9OlQ/exec';
        let fullData = {}; 
        let currentArticleIdToEdit = null;
        let isContributorMode = false;

        const modal = document.getElementById('adminModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const shareModal = document.getElementById('shareModal');
        const confirmModal = document.getElementById('confirmModal');
        let onConfirmAction = null;

        function openModal(type, articleId = null) {
            currentArticleIdToEdit = articleId;
            if (type === 'share') {
                const idToShare = fullData.article?.id;
                if (idToShare) {
                    document.getElementById('share-link-public').value = `${window.location.origin}${window.location.pathname}?berita=${idToShare}&view=public`;
                    document.getElementById('share-link-contributor').value = `${window.location.origin}${window.location.pathname}?mode=penulis`;
                    shareModal.style.display = 'flex';
                } else { alert("Tidak ada berita untuk dibagikan."); }
            } else {
                if (type === 'new-article') { modalTitle.innerText = 'Tulis Berita Baru'; populateArticleForm(); }
                else if (type === 'edit-article') { modalTitle.innerText = 'Edit Berita'; modalBody.innerHTML = '<p>Memuat data berita...</p>'; modal.style.display = 'flex'; populateArticleForm(articleId); }
                else if (type === 'settings') { modalTitle.innerText = 'Edit Pengaturan Umum'; populateSettingsForm(); }
                else if (type === 'archive') { modalTitle.innerText = 'Arsip Berita'; populateArchiveModal(); }
                if(type !== 'edit-article') modal.style.display = 'flex';
            }
        }

        function closeModal() {
            modal.style.display = 'none';
            modalBody.innerHTML = '';
            shareModal.style.display = 'none';
            confirmModal.style.display = 'none';
        }

        function showConfirmModal(message, callback) {
            document.getElementById('confirm-message').innerText = message;
            confirmModal.style.display = 'flex';
            onConfirmAction = callback;
        }

        document.getElementById('confirm-btn-yes').addEventListener('click', () => {
            if (onConfirmAction) {
                onConfirmAction();
            }
            confirmModal.style.display = 'none';
        });
        document.getElementById('confirm-btn-no').addEventListener('click', closeModal);

        function showNotification(message, type = 'error', panel = 'article') {
            const notificationId = panel === 'article' ? 'articleNotification' : (panel === 'archive' ? 'archiveNotification' : 'settingsNotification');
            const notificationElement = document.getElementById(notificationId);
            if (notificationElement) {
                notificationElement.textContent = message;
                notificationElement.className = `notification ${type} show`;
                setTimeout(() => { notificationElement.className = 'notification'; }, 5000);
            }
        }

        document.getElementById('btn-new-article').addEventListener('click', () => openModal('new-article'));
        document.getElementById('btn-archive').addEventListener('click', () => openModal('archive'));
        document.getElementById('btn-edit-pengaturan').addEventListener('click', () => openModal('settings'));
        document.getElementById('btn-share').addEventListener('click', () => openModal('share'));
        document.getElementById('modalClose').addEventListener('click', closeModal);
        document.getElementById('shareModalClose').addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        shareModal.addEventListener('click', (e) => { if (e.target === shareModal) closeModal(); });
        confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) closeModal(); });
        
        async function populateArticleForm(articleId) {
            let article = { imageUrls: [''] };
            let buttonText = 'Publikasikan';
            let formType = 'article-new';

            if (articleId) {
                buttonText = 'Perbarui Berita';
                formType = 'article-update';
                try {
                    const response = await fetch(`${GOOGLE_SHEET_WEB_APP_URL}?berita=${articleId}`);
                    const result = await response.json();
                    if(result.success) article = result.data.article;
                    else throw new Error(result.message);
                } catch(e) {
                    showNotification('Gagal memuat data berita untuk diedit.', 'error');
                    return;
                }
            }
            
            let authorInputHtml = '';
            if (isContributorMode) {
                const savedName = localStorage.getItem('namaPenulis') || '';
                authorInputHtml = `<div class="form-group"><label for="modalNamaPenulis">Nama Penulis:</label><input type="text" id="modalNamaPenulis" value="${escapeHTML(savedName)}"></div>`;
            }
            let photoInputsHtml = (article.imageUrls && article.imageUrls.length > 0 ? article.imageUrls : ['']).map((url, index) => `<div class="ai-prompt-group" style="margin-bottom: 10px;"><input type="url" class="photo-link-input" value="${escapeHTML(url || '')}" placeholder="Link foto ${index + 1}"><button class="btn-update" onclick="removePhotoInput(this)" style="background: #dc3545; width: auto; padding: 8px 10px;">-</button></div>`).join('');
            modalBody.innerHTML = `
                <div id="articleNotification" class="notification"></div>
                ${authorInputHtml}
                <div class="ai-generator-section">
                    <p>✨ Buat Teks Otomatis dengan AI</p>
                    <div class="ai-prompt-group">
                        <div class="form-group"><label for="aiTextPrompt">Topik Berita:</label><input type="text" id="aiTextPrompt" placeholder="Contoh: Aksi bersih-bersih masjid..."></div>
                        <button class="btn-update" onclick="generateWithGemini(this)"><span class="btn-text">Buat</span><div class="spinner"></div></button>
                    </div>
                </div>
                <div class="form-group"><label>Judul Berita:</label><input type="text" id="modalJudul" value="${escapeHTML(article.title || '')}"></div>
                <div class="form-group"><label>Isi Berita:</label><textarea id="modalIsi">${escapeHTML(article.content || '')}</textarea></div>
                <div class="form-group">
                    <label>Link/URL Foto:</label>
                    <div id="photo-inputs-container">${photoInputsHtml}</div>
                    <button class="btn-update" id="add-photo-btn" onclick="addPhotoInput()" style="background: #007bff; font-size: 0.9em; padding: 8px;">+ Tambah Foto</button>
                </div>
                <button class="btn-update" onclick="updateArticle(event, '${formType}')"><span class="btn-text">${buttonText}</span><div class="spinner"></div></button>
            `;
            checkPhotoLimit();
        }

        window.addPhotoInput = function() {
            const container = document.getElementById('photo-inputs-container');
            if (container.children.length < 4) {
                const newIndex = container.children.length + 1;
                const newPhotoInput = document.createElement('div');
                newPhotoInput.className = 'ai-prompt-group';
                newPhotoInput.style.marginBottom = '10px';
                newPhotoInput.innerHTML = `<input type="url" class="photo-link-input" placeholder="Link foto ${newIndex}"><button class="btn-update" onclick="removePhotoInput(this)" style="background: #dc3545; width: auto; padding: 8px 10px;">-</button>`;
                container.appendChild(newPhotoInput);
            }
            checkPhotoLimit();
        }

        window.removePhotoInput = function(button) {
            button.parentElement.remove();
            checkPhotoLimit();
        }

        function checkPhotoLimit() {
            const container = document.getElementById('photo-inputs-container');
            const addBtn = document.getElementById('add-photo-btn');
            if (container && addBtn) {
                addBtn.style.display = container.children.length >= 4 ? 'none' : 'block';
            }
        }

        function populateSettingsForm() {
            const createSettingRow = (key, label, inputType = 'text', isTextarea = false) => {
                const settings = fullData.settings || { current: {} };
                const currentValue = settings.current[key] || '';
                let inputElement = isTextarea 
                    ? `<textarea id="modal${key}" rows="5" style="width:100%">${escapeHTML(currentValue)}</textarea>`
                    : `<input type="${inputType}" id="modal${key}" value="${escapeHTML(currentValue)}">`;
                return `<div class="setting-row"><div class="setting-input-group"><label for="modal${key}">${label}:</label>${inputElement}</div><button class="btn-apply" onclick="updateSingleSetting('${key}', this)"><span class="btn-text">Terapkan</span><div class="spinner" style="width:14px; height:14px; border-width:2px;"></div></button></div>`;
            };
            modalBody.innerHTML = `<div id="settingsNotification" class="notification"></div>
                ${createSettingRow('Nama_Majalah', 'Nama Majalah')}
                ${createSettingRow('Deskripsi_Halaman', 'Deskripsi Halaman', 'text', true)}
                ${createSettingRow('Link_Logo_KUA', 'Link Logo KUA', 'url')}
                ${createSettingRow('Link_Logo_Masjid', 'Link Logo Masjid', 'url')}
                ${createSettingRow('Medsos', 'Nama Akun Facebook')}
                ${createSettingRow('Link_Facebook', 'Link Halaman Facebook', 'url')}
                ${createSettingRow('No_HP', 'Nomor HP')}
                ${createSettingRow('Alamat', 'Alamat Sekretariat')}
                ${createSettingRow('AI_System_Prompt', 'Prompt Teks AI', 'text', true)}
            `;
        }
        
        function displayContent(data) {
            const article = data.article || {}; 
            const settings = data.settings.current || {};
            const recentArticles = data.recentArticles || [];
            const formatUrl = (url) => {
                if (!url || typeof url !== 'string' || url.trim() === '') return '#';
                if (url.startsWith('http://') || url.startsWith('https://')) return url;
                return `https://${url}`;
            };
            document.title = article.title || settings.Nama_Majalah || "Majalah Digital";
            document.querySelector('meta[name="description"]').setAttribute("content", (article.content || "Baca berita terkini").substring(0, 155));
            document.querySelector('meta[property="og:title"]').setAttribute("content", article.title || settings.Nama_Majalah || "Majalah Digital");
            document.querySelector('meta[property="og:description"]').setAttribute("content", (article.content || "Baca berita terkini").substring(0, 155));
            document.querySelector('meta[property="og:image"]').setAttribute("content", article.imageUrls?.[0] || 'https://via.placeholder.com/1200x630.png?text=Majalah+Digital');
            
            document.getElementById('artikelJudul').innerText = article.title || "Belum Ada Berita";
            
            const teksContainer = document.getElementById('artikelTeks');
            teksContainer.innerHTML = article.content ? article.content.replace(/\n/g, '<br>') : "<p>Silakan masukkan berita pertama.</p>";

            const fotoContainer = document.getElementById('foto-container');
            const fotoSampingDiv = fotoContainer.parentElement;
            fotoContainer.innerHTML = '';
            const imageUrls = article.imageUrls || [];
            if (imageUrls.length > 0 && imageUrls[0]) {
                fotoSampingDiv.style.display = 'block';
                fotoSampingDiv.setAttribute('data-count', imageUrls.length);
                imageUrls.forEach(url => {
                    if(url.trim() !== '') {
                        fotoContainer.innerHTML += `<a href="${formatUrl(url)}" target="_blank"><img src="${url}" alt="Foto Berita"></a>`;
                    }
                });
            } else {
                fotoSampingDiv.style.display = 'none';
            }

            document.getElementById('namaMajalah').innerText = settings.Nama_Majalah || 'MAJALAH KITA';
            document.getElementById('majalahSubtitle').innerText = settings.Deskripsi_Halaman || '';
            
            const logoKuaContainer = document.querySelector('.logo-kua');
            const logoMasjidContainer = document.querySelector('.logo-masjid');
            if (settings.Link_Logo_KUA && settings.Link_Logo_KUA.trim() !== '') {
                logoKuaContainer.style.display = 'block';
                logoKuaContainer.querySelector('a').href = formatUrl(settings.Link_Logo_KUA);
                logoKuaContainer.querySelector('img').src = settings.Link_Logo_KUA;
            } else {
                logoKuaContainer.style.display = 'none';
            }

            if (settings.Link_Logo_Masjid && settings.Link_Logo_Masjid.trim() !== '') {
                logoMasjidContainer.style.display = 'block';
                logoMasjidContainer.querySelector('a').href = formatUrl(settings.Link_Logo_Masjid);
                logoMasjidContainer.querySelector('img').src = settings.Link_Logo_Masjid;
            } else {
                logoMasjidContainer.style.display = 'none';
            }

            const medsosDiv = document.getElementById('footerMedsos');
            medsosDiv.innerHTML = `<a id="medsosLink" href="${formatUrl(settings.Link_Facebook)}" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951z"/></svg><span>${settings.Medsos || 'Facebook'}</span></a>`;
            document.getElementById('footerKontak').innerHTML = `<strong>Nomor HP:</strong> ${settings.No_HP || 'N/A'}`;
            document.getElementById('footerAlamat').innerHTML = `<strong>Sekretariat:</strong> ${settings.Alamat || 'N/A'}`;
            
            const newsTicker = document.getElementById('news-ticker');
            newsTicker.innerHTML = '';
            if (recentArticles.length > 0) {
                let tickerContent = '';
                recentArticles.forEach(item => {
                    tickerContent += `<a href="?berita=${item.id}" class="news-ticker-item">${escapeHTML(item.title)}</a> ★ `;
                });
                newsTicker.innerHTML = tickerContent.repeat(3);
            }
            
            setupClickTrackers();
        }
        
        async function loadAllContent() {
            const skeleton = document.getElementById('skeleton-loader');
            const mainContent = document.getElementById('majalah-wrapper');
            const errorContainer = document.getElementById('error-container');
            const params = new URLSearchParams(window.location.search);
            const beritaId = params.get('berita');
            
            skeleton.style.display = 'block'; mainContent.style.display = 'none'; errorContainer.style.display = 'none';
            try {
                const fetchUrl = GOOGLE_SHEET_WEB_APP_URL + (beritaId ? '?berita=' + beritaId : '');
                const response = await fetch(fetchUrl);
                if (!response.ok) throw new Error(`Network response error: ${response.statusText}`);
                const result = await response.json();
                if (result.success) {
                    fullData = result.data;
                    displayContent(fullData);
                    skeleton.style.display = 'none'; mainContent.style.display = 'block';
                    setTimeout(() => { mainContent.style.opacity = '1'; }, 50);
                } else { throw new Error(result.message || "Gagal mengambil data dari skrip."); }
            } catch (error) {
                console.error("Gagal mengambil data:", error);
                let userMessage = "Tidak dapat memuat konten dari Google Sheet.";
                if (error.message && error.message.toLowerCase().includes("tidak ditemukan")) {
                    userMessage = `Error Konfigurasi Kritis: ${error.message}. Pastikan nama sheet Anda sudah benar.`;
                } else if (error.message) { userMessage = `Gagal memuat: ${error.message}`; }
                skeleton.style.display = 'none'; document.getElementById('error-message').innerText = userMessage; errorContainer.style.display = 'block';
            }
        }

        async function sendData(payload, button, panel, successCallback) {
            button.classList.add('loading');
            button.disabled = true;
            try {
                const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8', },
                    body: JSON.stringify(payload), redirect: 'follow'
                });
                const result = await response.json();
                if (result.success){
                    if (successCallback) {
                        successCallback();
                    } else {
                        showNotification(result.message || "Data berhasil disimpan!", 'success', panel);
                        setTimeout(() => { closeModal(); window.location.search = ''; }, 1500);
                    }
                } else { throw new Error(result.message || "Terjadi kesalahan pada skrip."); }
            } catch (error) {
                console.error("Error menyimpan dokumen:", error);
                let userMessage = `Gagal menyimpan: ${error.message}`;
                showNotification(userMessage, 'error', panel);
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }
        
        window.generateWithGemini = async function(button) {
            const promptInput = document.getElementById('aiTextPrompt');
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) {
                showNotification("Harap masukkan topik berita untuk AI.", 'error', 'article');
                return;
            }
            button.classList.add('loading');
            button.disabled = true;
            
            const payload = {
                type: 'generate-ai-content',
                data: {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    tools: [{ "google_search": {} }]
                }
            };
            const systemPrompt = fullData.settings?.current?.AI_System_Prompt;
            if (systemPrompt && systemPrompt.trim() !== '') {
                payload.data.systemInstruction = { parts: [{ text: systemPrompt }] };
            }
            
            try {
                const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST', body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.message);

                const candidate = result.data.candidates?.[0];
                let generatedText = candidate?.content?.parts?.[0]?.text;
                if (!generatedText) throw new Error("Respon dari AI kosong atau tidak valid.");
                
                let title = '', content = '';
                const titleMatch = generatedText.match(/\[JUDUL\]\s*([\s\S]*?)\s*\[ISI\]/);
                const contentMatch = generatedText.match(/\[ISI\]\s*([\s\S]*)/);

                if (titleMatch && contentMatch) {
                    title = titleMatch[1].trim();
                    content = contentMatch[1].trim();
                } else {
                    const lines = generatedText.split('\n').filter(line => line.trim() !== '');
                    if (lines.length > 1) {
                        title = lines[0].trim();
                        content = lines.slice(1).join('\n').trim();
                    } else { content = generatedText.trim(); }
                }
                document.getElementById('modalJudul').value = title;
                document.getElementById('modalIsi').value = content;
                showNotification("Konten berhasil dibuat oleh AI! Silakan tinjau.", 'success', 'article');
            } catch (error) {
                console.error("Error generating content with AI:", error);
                showNotification(`Gagal membuat konten dengan AI: ${error.message}`, 'error', 'article');
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
            }
        };

        async function populateArchiveModal() {
            modalBody.innerHTML = '<p>Memuat arsip...</p>';
            try {
                const response = await fetch(`${GOOGLE_SHEET_WEB_APP_URL}?action=list`);
                const result = await response.json();
                if (!result.success) throw new Error(result.message);
                
                let archiveHtml = '<div id="archiveNotification" class="notification"></div><ul class="archive-list">';
                if (result.data.length === 0) {
                    archiveHtml += '<li>Belum ada berita di arsip.</li>';
                } else {
                    result.data.forEach(article => {
                        archiveHtml += `<li class="archive-item" id="item-${article.id}">
                            <span>${escapeHTML(article.title)}</span>
                            <div>
                                <button class="btn-apply" onclick="window.location.href='${window.location.origin}${window.location.pathname}?berita=${article.id}'; closeModal();">Lihat</button>
                                <button class="btn-apply" onclick="openModal('edit-article', '${article.id}')">Edit</button>
                                <button class="btn-apply" style="background: #c82333;" onclick="deleteArticle('${article.id}', this)">Hapus</button>
                            </div>
                        </li>`;
                    });
                }
                archiveHtml += '</ul>';
                modalBody.innerHTML = archiveHtml;
            } catch (error) {
                modalBody.innerHTML = '<p style="color: red;">Gagal memuat arsip.</p>';
            }
        }

        window.deleteArticle = async function(articleId, button) {
            showConfirmModal("Apakah Anda yakin ingin menghapus berita ini secara permanen?", () => {
                const payload = { type: 'article-delete', articleId: articleId };
                sendData(payload, button, 'archive', () => {
                    showNotification("Berita berhasil dihapus!", 'success', 'archive');
                    const itemToRemove = document.getElementById(`item-${article.id}`);
                    if (itemToRemove) itemToRemove.remove();
                });
            });
        }
        
        function updateDOMForKey(key, value) {
            const formatUrl = (url) => {
                if (!url || typeof url !== 'string' || url.trim() === '') return '#';
                if (url.startsWith('http://') || url.startsWith('https://')) { return url; }
                return `https://${url}`;
            };
            switch (key) {
                case 'Nama_Majalah': document.getElementById('namaMajalah').innerText = value; break;
                case 'Deskripsi_Halaman': document.getElementById('majalahSubtitle').innerText = value; break;
                case 'Link_Logo_KUA': document.getElementById('logoKuaLink').href = formatUrl(value); document.getElementById('logoKuaImg').src = value || 'https://via.placeholder.com/150x150.png?text=Logo+KUA'; break;
                case 'Link_Logo_Masjid': document.getElementById('logoMasjidLink').href = formatUrl(value); document.getElementById('logoMasjidImg').src = value || 'https://via.placeholder.com/150x150.png?text=Logo+Masjid'; break;
                case 'Medsos': document.querySelector('#footerMedsos a span').innerText = value; break;
                case 'Link_Facebook': document.querySelector('#footerMedsos a').href = formatUrl(value); break;
                case 'No_HP': document.getElementById('footerKontak').innerHTML = `<strong>Nomor HP:</strong> ${value}`; break;
                case 'Alamat': document.getElementById('footerAlamat').innerHTML = `<strong>Sekretariat:</strong> ${value}`; break;
            }
        }

        window.updateSingleSetting = function(key, button) {
            const input = document.getElementById(`modal${key}`);
            const value = input.value.trim();
            const payload = { type: 'settings', data: { [key]: value } };
            
            sendData(payload, button, 'settings', () => {
                showNotification("Pengaturan diterapkan!", 'success', 'settings');
                fullData.settings.current[key] = value;
                updateDOMForKey(key, value);
            });
        };

        window.updateArticle = function(event, formType) {
            const photoInputs = document.querySelectorAll('.photo-link-input');
            const imageUrls = Array.from(photoInputs).map(input => input.value.trim()).filter(url => url);
            
            let content = document.getElementById('modalIsi').value.trim();
            if(isContributorMode) {
                const authorInput = document.getElementById('modalNamaPenulis');
                if (authorInput && authorInput.value.trim() !== '') {
                    const authorName = authorInput.value.trim();
                    localStorage.setItem('namaPenulis', authorName);
                    content += `\n\n(Penulis: ${authorName})`;
                }
            }

            const payload = { 
                type: formType, 
                articleId: currentArticleIdToEdit, 
                data: {
                    title: document.getElementById('modalJudul').value.trim(),
                    imageUrls: imageUrls,
                    content: content
                }
            };
            
            if (!payload.data.title || !payload.data.content) {
                showNotification("Harap isi Judul dan Isi Berita.", 'error', 'article');
                return;
            }
            sendData(payload, event.currentTarget, 'article', () => {
                showNotification("Berita berhasil disimpan!", 'success', 'article');
                setTimeout(() => { 
                    closeModal(); 
                    if(payload.type === 'article-update') {
                         window.location.href = window.location.origin + window.location.pathname + '?berita=' + payload.articleId;
                    } else {
                         window.location.href = window.location.origin + window.location.pathname;
                    }
                }, 1500);
            });
        }
        
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }
        
        function trackAndNavigate(linkId, event) {
            event.preventDefault();
            const destinationUrl = event.currentTarget.href;
            if (!destinationUrl || destinationUrl.endsWith('#')) return;

            const payload = { type: 'click', data: { linkId: linkId, destinationUrl: destinationUrl } };
            fetch(GOOGLE_SHEET_WEB_APP_URL, {
                method: 'POST', mode: 'no-cors', body: JSON.stringify(payload)
            }).catch(err => console.error("Gagal melacak klik:", err));

            window.open(destinationUrl, '_blank');
        }

        function setupClickTrackers() {
            document.getElementById('logoKuaLink').addEventListener('click', (e) => trackAndNavigate('logo_kua', e));
            document.getElementById('logoMasjidLink').addEventListener('click', (e) => trackAndNavigate('logo_masjid', e));
            const medsosLink = document.getElementById('medsosLink');
            if (medsosLink) {
                medsosLink.addEventListener('click', (e) => trackAndNavigate('facebook', e));
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const adminPanel = document.getElementById('admin-panel');
            if (params.get('view') === 'public') {
                adminPanel.style.display = 'none';
            } else if (params.get('mode') === 'penulis') {
                isContributorMode = true;
                adminPanel.innerHTML = '<button id="btn-new-article" class="admin-btn" style="background-color: var(--warna-utama); color: white;">Tulis Berita Baru</button>';
                document.getElementById('btn-new-article').addEventListener('click', () => openModal('new-article'));
            }
            loadAllContent();
        });

        window.copyShareLink = function(inputId) {
            const input = document.getElementById(inputId);
            input.select();
            input.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                alert('Link berhasil disalin!');
            } catch (err) {
                alert('Gagal menyalin link.');
            }
        }
    </script>
</body>
</html>

