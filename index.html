<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Majalah Digital Interaktif (Google Sheets)</title>
    <style>
        /* --- FONT & DASAR --- */
        :root {
            --warna-utama: #1b5e20;
            --warna-aksen: #ffc107;
        }
        body { font-family: 'Georgia', 'Times New Roman', Times, serif; margin: 0; padding: 0; background-color: #f8f9fa; color: #333; }

        /* --- Tombol Admin (Transparan & Lebih Kecil) --- */
        .admin-controls {
            max-width: 800px;
            margin: 20px auto;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            padding: 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .admin-btn {
            padding: 8px 18px;
            font-size: 0.9em;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #btn-new-article { background-color: var(--warna-utama); color: white; }
        #btn-edit-last-article { background-color: #546e7a; color: white; }
        #btn-edit-pengaturan { background-color: #e65100; color: white; }
        .admin-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        
        /* --- MODAL (POP-UP) (Transparan & Lebih Kecil) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(2px);
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 25px; border-radius: 12px; width: 90%; max-width: 550px;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            position: relative;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: var(--warna-utama); }
        .modal-close-btn { font-size: 2em; font-weight: bold; cursor: pointer; color: #aaa; line-height: 1; }
        .modal-close-btn:hover { color: #333; }

        /* --- FORMULIR DENGAN TOMBOL "TERAPKAN" PER INPUT --- */
        .setting-row {
            display: flex;
            flex-wrap: nowrap;
            align-items: flex-end;
            gap: 8px;
            padding-bottom: 12px;
            margin-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        .setting-input-group { flex-grow: 1; min-width: 0; }
        .setting-input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #2e7d32; font-size: 0.9em; }
        .input-with-history { display: flex; gap: 8px; }
        .input-with-history input { flex-grow: 1; }
        .input-with-history select { flex-basis: 100px; flex-shrink: 0; }
        .btn-apply {
            padding: 8px 12px; font-size: 0.8em; font-weight: bold; border-radius: 6px; border: none;
            background-color: #1976d2; color: white; cursor: pointer; transition: background-color 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            flex-shrink: 0;
        }
        .btn-apply:hover { background-color: #1565c0; }
        
        .notification { padding: 12px; margin-bottom: 15px; border-radius: 5px; text-align: center; font-weight: bold; display: none; border: 1px solid transparent; opacity: 0; transition: opacity 0.5s; }
        .notification.show { display: block; opacity: 1; }
        .notification.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .notification.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #2e7d32; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-group textarea { height: 120px; resize: vertical; }
        .btn-update { display: flex; justify-content: center; align-items: center; gap: 10px; width: 100%; padding: 12px; background-image: linear-gradient(to right, #28a745 0%, #218838 51%, #28a745 100%); background-size: 200% auto; color: white; border: none; border-radius: 5px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: 0.5s; }
        .btn-update:hover { background-position: right center; }
        .btn-update:disabled { cursor: not-allowed; opacity: 0.7; }
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; display: none; }
        .btn-update.loading .spinner, .btn-apply.loading .spinner { display: block; }
        .btn-update.loading .btn-text, .btn-apply.loading .btn-text { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .container-majalah { background-color: #ffffff; transition: opacity 0.5s ease-in; }
        
        header { 
            max-width: 800px;
            margin: 0 auto;
            box-sizing: border-box;
            display: flex; 
            align-items: center;
            padding: 15px 25px; 
            border-bottom: 4px solid var(--warna-aksen); 
        }
        header .logo { flex-shrink: 0; }
        header .logo img { height: 60px; width: auto; }
        header .logo a { display: inline-block; transition: transform 0.2s ease-in-out; }
        header .logo a:hover { transform: scale(1.05); }
        
        /* --- PERUBAHAN CSS JUDUL HALAMAN --- */
        header h1 { 
            font-size: clamp(1.5em, 4vw, 2.2em); 
            color: var(--warna-utama); 
            text-align: center; 
            margin: 0; 
            padding: 0 15px;
            flex-grow: 1;
            /* Properti baru untuk menangani judul yang panjang */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0; /* Trik agar flexbox bisa mengecilkan elemen */
        }

        main, .footer-content {
            max-width: 800px;
            margin: 0 auto;
            box-sizing: border-box;
        }
        main { padding: 25px; }
        article .judul-artikel { font-size: clamp(1.8em, 5vw, 2.2em); margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #388e3c; }
        
        .artikel-container::after { content: ""; clear: both; display: table; }
        .foto-samping { float: left; width: 45%; max-width: 320px; margin-right: 20px; margin-bottom: 15px; }
        .foto-samping img { width: 100%; height: auto; display: block; border-radius: 5px; background-color: #eee; }
        .teks-artikel { text-align: justify; line-height: 1.6; font-size: 1em; }
        
        footer { background-color: var(--warna-utama); color: #ffffff; padding: 20px 0; text-align: center; }
        .footer-content { display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 15px; font-size: 0.9em; padding: 0 15px; }
        #footerMedsos a { display: inline-flex; align-items: center; gap: 8px; text-decoration: none; color: white; transition: opacity 0.3s; }
        #footerMedsos a:hover { opacity: 0.8; }
        
        .skeleton { animation: skeleton-pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes skeleton-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .skeleton-text { height: 1em; background-color: #e0e0e0; border-radius: 4px; }
        .skeleton-img { background-color: #e0e0e0; }

        .read-more-mobile { display: none; }
        
        @media (max-width: 650px) { 
            body { padding: 0; padding-bottom: 85px; }
            .admin-controls { margin: 0; border-radius: 0; border-left: none; border-right: none; padding: 20px 10px; } 
            main { padding: 15px; }
            
            header {
                padding: 10px 15px;
            }
            header h1 {
                padding: 0 10px;
            }

            .teks-artikel { font-size: 1.1em; }
            .foto-samping { float: none; width: 100%; margin-right: 0; }
            
            footer {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                z-index: 999;
                box-shadow: 0 -3px 10px rgba(0,0,0,0.15);
                box-sizing: border-box;
            }
            .read-more-mobile {
                display: block;
                position: fixed;
                bottom: 85px;
                left: 0;
                width: 100%;
                padding: 30px 0 10px 0;
                background: linear-gradient(to bottom, transparent, #f8f9fa 50%);
                text-align: center;
                color: var(--warna-utama);
                font-weight: bold;
                font-style: italic;
                z-index: 998;
                pointer-events: none;
            }
        }
    </style>
</head>
<body>

    <div class="admin-controls">
        <button id="btn-new-article" class="admin-btn">Tulis Berita Baru</button>
        <button id="btn-edit-last-article" class="admin-btn">Edit Berita Terakhir</button>
        <button id="btn-edit-pengaturan" class="admin-btn">Edit Pengaturan</button>
    </div>

    <div id="adminModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <span id="modalClose" class="modal-close-btn">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <div id="majalah-wrapper" style="display:none; opacity:0;">
        <div class="container-majalah">
            <header>
                <div class="logo logo-kua"><a id="logoKuaLink" href="#" target="_blank"><img id="logoKuaImg" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Logo KUA"></a></div>
                <h1 id="namaMajalah"></h1>
                <div class="logo logo-masjid"><a id="logoMasjidLink" href="#" target="_blank"><img id="logoMasjidImg" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Logo Masjid"></a></div>
            </header>
            <main>
                <article>
                    <h2 class="judul-artikel" id="artikelJudul"></h2>
                    <div class="artikel-container">
                        <div class="foto-samping"><img id="artikelFoto" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Foto Berita"></div>
                        <div class="teks-artikel" id="artikelTeks"></div>
                    </div>
                </article>
            </main>
            <div class="read-more-mobile">...baca selengkapnya</div>
            <footer>
                <div class="footer-content">
                    <div id="footerMedsos"></div>
                    <div id="footerKontak"></div>
                    <div id="footerAlamat"></div>
                </div>
            </footer>
        </div>
    </div>

    <div id="skeleton-loader"><div class="container-majalah"><header class="skeleton"><div style="height: 90px;"></div></header><main><div class="judul-artikel skeleton skeleton-text" style="height: 2.2em; width: 80%; margin-bottom: 20px;"></div><div class="artikel-container"><div class="foto-samping skeleton skeleton-img" style="height: 250px;"></div><div class="teks-artikel"><p class="skeleton skeleton-text"></p><p class="skeleton skeleton-text"></p><p class="skeleton skeleton-text"></p></div></div></main><footer class="skeleton"><div style="height: 65px;"></div></footer></div></div>
    <div id="error-container" style="display: none; max-width: 800px; margin: 20px auto; padding: 20px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; color: #721c24;"><h2>Masalah Kritis</h2><p id="error-message"></p><p>Periksa kembali panduan penyiapan Google Sheets Anda.</p></div>

    <script>
        const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzswbfPgXcpUzsP3oHTt16-kPUBPcFceebghaBdXeKgOo9aq7932mZi20e8Orxcor9OlQ/exec';
        let fullData = {}; 
        let isEditingArticle = false;

        const modal = document.getElementById('adminModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        function openModal(type) {
            if (type === 'new-article') {
                isEditingArticle = false;
                modalTitle.innerText = 'Tulis Berita Baru';
                populateArticleForm();
            } else if (type === 'edit-article') {
                isEditingArticle = true;
                modalTitle.innerText = 'Edit Berita Terakhir';
                populateArticleForm();
            } else if (type === 'settings') {
                modalTitle.innerText = 'Edit Pengaturan Umum';
                populateSettingsForm();
            }
            modal.style.display = 'flex';
        }

        function closeModal() {
            modal.style.display = 'none';
            modalBody.innerHTML = '';
        }

        function showNotification(message, type = 'error', panel = 'article') {
            const notificationId = panel === 'article' ? 'articleNotification' : 'settingsNotification';
            const notificationElement = document.getElementById(notificationId);
            if (notificationElement) {
                notificationElement.textContent = message;
                notificationElement.className = `notification ${type} show`;
                setTimeout(() => { notificationElement.className = 'notification'; }, 5000);
            }
        }

        document.getElementById('btn-new-article').addEventListener('click', () => openModal('new-article'));
        document.getElementById('btn-edit-last-article').addEventListener('click', () => openModal('edit-article'));
        document.getElementById('btn-edit-pengaturan').addEventListener('click', () => openModal('settings'));
        document.getElementById('modalClose').addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        
        function populateArticleForm() {
            const article = isEditingArticle ? (fullData.article || {}) : {};
            const buttonText = isEditingArticle ? 'Perbarui Berita' : 'Publikasikan';
            modalBody.innerHTML = `
                <div id="articleNotification" class="notification"></div>
                <div class="form-group"><label>Judul Berita:</label><input type="text" id="modalJudul" value="${escapeHTML(article.title || '')}"></div>
                <div class="form-group"><label>Link/URL Foto:</label><input type="url" id="modalFotoLink" value="${escapeHTML(article.imageUrl || '')}"></div>
                <div class="form-group"><label>Isi Berita:</label><textarea id="modalIsi">${escapeHTML(article.content || '')}</textarea></div>
                <button class="btn-update" onclick="updateArticle(event)"><span class="btn-text">${buttonText}</span><div class="spinner"></div></button>
            `;
        }

        function populateSettingsForm() {
            const shortenText = (text, maxLength = 25) => {
                if (typeof text !== 'string' || text.length <= maxLength) return text;
                return text.substring(0, maxLength) + '...';
            };

            const createSettingRow = (key, label, inputType = 'text') => {
                const settings = fullData.settings || { current: {}, history: {} };
                const currentValue = settings.current[key] || '';
                const historyItems = settings.history[key] || [];
                const keysToShorten = ['Link_Logo_KUA', 'Link_Logo_Masjid', 'Link_Facebook', 'Alamat', 'Medsos', 'No_HP'];

                let options = historyItems.map(item => {
                    const displayText = keysToShorten.includes(key) ? shortenText(item) : item;
                    return `<option value="${escapeHTML(item)}">${escapeHTML(displayText)}</option>`;
                }).join('');

                return `
                    <div class="setting-row">
                        <div class="setting-input-group">
                            <label for="modal${key}">${label}:</label>
                            <div class="input-with-history">
                                <input type="${inputType}" id="modal${key}" value="${escapeHTML(currentValue)}">
                                <select onchange="document.getElementById('modal${key}').value = this.value;">
                                    <option value="">Riwayat</option>
                                    ${options}
                                </select>
                            </div>
                        </div>
                        <button class="btn-apply" onclick="updateSingleSetting('${key}', this)">
                            <span class="btn-text">Terapkan</span>
                            <div class="spinner" style="width:14px; height:14px; border-width:2px;"></div>
                        </button>
                    </div>`;
            };
            modalBody.innerHTML = `
                <div id="settingsNotification" class="notification"></div>
                ${createSettingRow('Nama_Majalah', 'Nama Majalah')}
                ${createSettingRow('Link_Logo_KUA', 'Link Logo KUA', 'url')}
                ${createSettingRow('Link_Logo_Masjid', 'Link Logo Masjid', 'url')}
                ${createSettingRow('Medsos', 'Nama Akun Facebook')}
                ${createSettingRow('Link_Facebook', 'Link Halaman Facebook', 'url')}
                ${createSettingRow('No_HP', 'Nomor HP')}
                ${createSettingRow('Alamat', 'Alamat Sekretariat')}
            `;
        }

        function displayContent(data) {
            const article = data.article || {}; 
            const settings = data.settings.current || {};
            
            document.getElementById('artikelJudul').innerText = article.title || "Belum Ada Berita";
            document.getElementById('artikelFoto').src = article.imageUrl || "https://placehold.co/250x250?text=Gambar";
            const teksContainer = document.getElementById('artikelTeks');
            teksContainer.innerHTML = '';
            if(article.content){ article.content.split('\n').forEach(p => { if(p.trim() !== ''){ const newP = document.createElement('p'); newP.innerText = p; teksContainer.appendChild(newP); }}); } else { teksContainer.innerHTML = "<p>Silakan masukkan berita pertama.</p>"; }
            
            document.getElementById('namaMajalah').innerText = settings.Nama_Majalah || 'MAJALAH KITA';
            document.getElementById('logoKuaLink').href = settings.Link_Logo_KUA || '#';
            document.getElementById('logoKuaImg').src = settings.Link_Logo_KUA || 'https://via.placeholder.com/150x150.png?text=Logo+KUA';
            document.getElementById('logoMasjidLink').href = settings.Link_Logo_Masjid || '#';
            document.getElementById('logoMasjidImg').src = settings.Link_Logo_Masjid || 'https://via.placeholder.com/150x150.png?text=Logo+Masjid';
            
            const medsosDiv = document.getElementById('footerMedsos');
            medsosDiv.innerHTML = `<a href="${settings.Link_Facebook || '#'}" target="_blank" rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951z"/></svg>
                <span>${settings.Medsos || 'Facebook'}</span>
            </a>`;
            document.getElementById('footerKontak').innerHTML = `<strong>Nomor HP:</strong> ${settings.No_HP || 'N/A'}`;
            document.getElementById('footerAlamat').innerHTML = `<strong>Sekretariat:</strong> ${settings.Alamat || 'N/A'}`;
        }
        
        async function loadAllContent() {
            const skeleton = document.getElementById('skeleton-loader');
            const mainContent = document.getElementById('majalah-wrapper');
            const errorContainer = document.getElementById('error-container');
            skeleton.style.display = 'block'; mainContent.style.display = 'none'; errorContainer.style.display = 'none';

            try {
                const response = await fetch(GOOGLE_SHEET_WEB_APP_URL);
                if (!response.ok) throw new Error(`Network response error: ${response.statusText}`);
                const result = await response.json();
                if (result.success) {
                    fullData = result.data;
                    displayContent(fullData);
                    skeleton.style.display = 'none'; mainContent.style.display = 'block';
                    setTimeout(() => { mainContent.style.opacity = '1'; }, 50);
                } else { throw new Error(result.message || "Gagal mengambil data dari skrip."); }
            } catch (error) {
                console.error("Gagal mengambil data:", error);
                let userMessage = "Tidak dapat memuat konten dari Google Sheet.";
                if (error.message && error.message.toLowerCase().includes("cannot read properties of null")) {
                    userMessage = "Error Konfigurasi Kritis: Gagal membaca salah satu sheet. Pastikan Anda memiliki dua sheet dengan nama persis 'Konten' dan 'Settings_History' (perhatikan huruf besar/kecil).";
                } else if (error.message) { userMessage = `Gagal memuat: ${error.message}`; }
                skeleton.style.display = 'none'; document.getElementById('error-message').innerText = userMessage; errorContainer.style.display = 'block';
            }
        }

        async function sendData(payload, button, panel, successCallback) {
            button.classList.add('loading');
            button.disabled = true;

            try {
                const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8', },
                    body: JSON.stringify(payload), redirect: 'follow'
                });
                const result = await response.json();
                if (result.success){
                    if (successCallback) {
                        successCallback();
                    } else {
                        showNotification(result.message || "Data berhasil disimpan!", 'success', panel);
                        setTimeout(() => { closeModal(); loadAllContent(); }, 1500);
                    }
                } else { throw new Error(result.message || "Terjadi kesalahan pada skrip."); }
            } catch (error) {
                console.error("Error menyimpan dokumen:", error);
                let userMessage = `Gagal menyimpan: ${error.message}`;
                if (error.message && error.message.toLowerCase().includes("cannot read properties of null")) {
                     userMessage = "Error Konfigurasi Kritis: Gagal menyimpan karena nama sheet salah.";
                }
                showNotification(userMessage, 'error', panel);
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }
        
        function updateDOMForKey(key, value) {
            switch (key) {
                case 'Nama_Majalah': document.getElementById('namaMajalah').innerText = value; break;
                case 'Link_Logo_KUA': document.getElementById('logoKuaLink').href = value; document.getElementById('logoKuaImg').src = value; break;
                case 'Link_Logo_Masjid': document.getElementById('logoMasjidLink').href = value; document.getElementById('logoMasjidImg').src = value; break;
                case 'Medsos': document.querySelector('#footerMedsos a span').innerText = value; break;
                case 'Link_Facebook': document.querySelector('#footerMedsos a').href = value; break;
                case 'No_HP': document.getElementById('footerKontak').innerHTML = `<strong>Nomor HP:</strong> ${value}`; break;
                case 'Alamat': document.getElementById('footerAlamat').innerHTML = `<strong>Sekretariat:</strong> ${value}`; break;
            }
        }

        window.updateSingleSetting = function(key, button) {
            const input = document.getElementById(`modal${key}`);
            const value = input.value.trim();
            const payload = { type: 'settings', data: { [key]: value } };
            
            sendData(payload, button, 'settings', () => {
                showNotification("Pengaturan diterapkan!", 'success', 'settings');
                fullData.settings.current[key] = value;
                if (!fullData.settings.history[key]) fullData.settings.history[key] = [];
                if (fullData.settings.history[key].indexOf(value) === -1) fullData.settings.history[key].push(value);
                updateDOMForKey(key, value);
            });
        };

        window.updateArticle = function(event) {
            const payload = { type: 'article', isEdit: isEditingArticle, data: {
                title: document.getElementById('modalJudul').value.trim(),
                imageUrl: document.getElementById('modalFotoLink').value.trim(),
                content: document.getElementById('modalIsi').value.trim()
            }};
            if (!payload.data.title || !payload.data.imageUrl || !payload.data.content) {
                showNotification("Harap isi semua kolom berita.", 'error', 'article');
                return;
            }
            sendData(payload, event.currentTarget, 'article');
        }
        
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }
        
        document.addEventListener('DOMContentLoaded', loadAllContent);
    </script>
</body>
</html>

